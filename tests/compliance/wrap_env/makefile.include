# ======= autodiscovery (no env vars required) =======
# riscof sets $(env) to THIS folder (wrap_env). try git first for repo root.
PROJ_ROOT := $(shell git rev-parse --show-toplevel 2>/dev/null)
ifeq ($(PROJ_ROOT),)
PROJ_ROOT := $(abspath $(env)/../../..)
endif

# suite env (headers/linker/helpers) – keep the original location
SUITE_ENV := $(abspath $(env)/../riscv-arch-test/riscv-test-suite/env)

# spike binary: PATH first, then typical submodule build path
SPIKE_BIN := $(shell command -v spike 2>/dev/null || \
                    test -x $(PROJ_ROOT)/tests/compliance/riscv-isa-sim/build/spike && \
                    echo $(PROJ_ROOT)/tests/compliance/riscv-isa-sim/build/spike)
ifeq ($(SPIKE_BIN),)
$(error Could not find 'spike'. Put it in PATH or build at tests/compliance/riscv-isa-sim/build/spike)
endif

# dut runner:
#   look in common places: build/, build/obj_dir/ (verilator), sim/, out/, bin/
#   match typical names: insper*, *dut*, *sim*, V*
DUT_SIM := $(shell \
  for d in \
    $(PROJ_ROOT)/build \
    $(PROJ_ROOT)/build/obj_dir \
    $(PROJ_ROOT)/sim \
    $(PROJ_ROOT)/out \
    $(PROJ_ROOT)/bin \
    $(PROJ_ROOT); do \
    find $$d -maxdepth 2 -type f -perm -111 \
      \( -name 'insper*' -o -name '*dut*' -o -name '*sim*' -o -name 'V*' \) \
      2>/dev/null | head -n1 && break; \
  done)
ifeq ($(DUT_SIM),)
$(error Could not auto-detect DUT simulator. Put your executable under build/, build/obj_dir/, sim/, out/, or bin/ with a sensible name (insper*, *dut*, *sim*, or V*).)
endif

# include suite env helpers if present (safe to miss)
-include $(SUITE_ENV)/macros.mk

# helpful log lines in riscof output
$(info [wrap_env] PROJ_ROOT = $(PROJ_ROOT))
$(info [wrap_env] SUITE_ENV = $(SUITE_ENV))
$(info [wrap_env] SPIKE_BIN = $(SPIKE_BIN))
$(info [wrap_env] DUT_SIM   = $(DUT_SIM))

# ======= reference: spike =======
spike-compile:
	@true

spike-run: $(work)/my.elf
	@echo "[REF] Spike → $(signature)"
	"$(SPIKE_BIN)" --isa=RV32I "$(work)/my.elf" >/dev/null 2>&1 || true
	# write the signature (swap out if you have a different helper)
	python3 "$(SUITE_ENV)/sig.py" --elf "$(work)/my.elf" --out "$(signature)"
	@test -f "$(signature)" || (echo "Spike did not produce $(signature)"; exit 1)

# ======= dut: plugin name must match config.ini =======
riscv_insper-compile:
	@true

riscv_insper-run: $(work)/my.elf
	@echo "[DUT] riscv_insper (runner: $(DUT_SIM)) → $(signature)"
	@if test -x "$(DUT_SIM)"; then \
		"$(DUT_SIM)" +elf="$(work)/my.elf" +signature="$(signature)"; \
	else \
		echo "[DUT] No simulator found; will try OPTION B post-process if a memory dump appears."; \
	fi
	@if test -f "$(signature)"; then exit 0; fi